#!/usr/bin/python

# this reports the latest scale reading so the web page can grab it

import MySQLdb as mdb
import os
import sys
print "Content-type: text/html\n\n"

debug = 1 
con = None
full = float(1670)
empty = float(196) 
scale_id = 1
try:
# connect to database
	con = mdb.connect('localhost', 'coffeeuser', 'coffee16', 'coffeedb');
	cur = con.cursor(mdb.cursors.DictCursor)
# get scale IDs from scales table
# for each ID found, get its latest reading and display appropriately...!
	# get most recently added reading
	cur.execute("select * from readings where reading_time = (select MAX(reading_time) from readings)")	 
# this should produce ONE row but in case it does not I'll refer to the rows by their numeric index
	rows = cur.fetchall() # fetchall so we can refer to the columns by name
	lastreading = str(rows[0]["reading_value"])
	lastreadtime = str(rows[0]["reading_time"])
	units = rows[0]["reading_units"]
	cur.close()
	if con: con.close()
	if debug: print "from database"+"<br />\n"
	if debug: print "most recent reading time: " + lastreadtime +"<br />\n"
	if debug: print "most recent value : " + lastreading +" "+ units +"<br />\n"
	lastreading = float(lastreading)
	print "<br />\n"
	if lastreading == 0 or lastreading < empty :
		print "water bottle missing<br />\n"
		pctfull = 0
	elif lastreading == empty :
		print "water bottle empty<br />\n"
		pctfull = 0
	else:
		pctfull = round((((lastreading - empty) / full)*100),2)
		print str(pctfull)+"% full<br />\n"
		pctpx = int(500 * ((lastreading - empty) / full))
except mdb.Error, e:
  
    print "Error %d: %s" % (e.args[0],e.args[1])
    sys.exit(1)
print """
	<div class="graph">
		<div>
		  <!-- height would be percent times 5 -->
			  <div style="height: 520px;width:1px;" class="barholder"></div>
"""
print "			  <div id=\"scale1\" style=\"height: "+ str(pctpx) +"px;\" class=\"bar\"></div>"
print """
		</div>
	</div>
"""
		